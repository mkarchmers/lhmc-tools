<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>LMHC-tool</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">  

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.min.css" />

    <style type="text/css">
      html, body {
        margin: 10px;
        padding: 0;
        font-family: "Lucida Grande",Helvetica,Arial,Verdana,sans-serif;
        font-size: 14px;
      }

      #external-events-container {
      }

      #calendar-container {
        margin-top: 20px;
      }

      #external-events .fc-event {
        margin: 1em 0;
        cursor: move;
      }

      .fc-center h2 {
        font-size: 15px;
      }
      .fc-day-header {
        font-size: 10px;
      }
      .fc-time {
        font-size: 10px;
      }

      .badge-pill { 
        float:right;
        font-size: 10px;
        color: #fff;
        margin: 1px 5px;
        padding: 0px 5px;
      }

      .weekly {
        background-color: #5F9EA0; 
      }
      .bi-weekly {
        background-color: #A52A2A;
      }

    </style>

  </head>

  <body>
    
    <div class="container">
      <div class="row">
        <div class="col-sm-3">
          <div id='external-events-container'>

            <div class="btn-group btn-group-xs">
              <button onClick="saveSchedule();">Save</button>
              <button onClick="clearSchedule();">Clear</button>
              <button onClick="load();">Load</button>
            </div>

            <div id="external-events">
              
            </div>
          </div>
        </div>

        <div class="col-sm-9">
          <div id='calendar-container'>

            <div id='calendar'></div>

          </div>
        </div>
      </div>
    </div>


    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script
      src="https://code.jquery.com/jquery-3.3.1.min.js"
      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
      crossorigin="anonymous"></script>
    <script
      src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
      integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
      crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.min.js"></script>

    <!-- make draggable work with mobile -->
    <script src="../js/jquery_touch.js"></script>

    <script>

      function getClassNameForFreq(freq){
        return (freq==7? "weekly" : "bi-weekly")
      }

      function badge(element, f){
        d = $(element).parent().data()
        $(element).text(d.event.data.freq)
        d.event.data.freq = (d.event.data.freq == 7? 14 : 7);
        d.event.className = getClassNameForFreq(d.event.data.freq)
        $(element).parent().data(d)

        $(element).parent().toggleClass('bi-weekly')
        $(element).parent().toggleClass('weekly')
        $(element).toggleClass('weekly')
        $(element).toggleClass('bi-weekly')
      }

      var schedule = {};

      function addEvent(event){
        var start = event.start;
        var end = event.end;
        schedule[event.title] = {
          name: event.title,
          moment: start.format(),
          dow: start.format('E'),
          start: start.format('HH:mm:ss'),
          end: end.format('HH:mm:ss'),
          freq: event.data.freq,
          pid: event.data.pid,
        }
      }

      function load(){
        schedule = {}
        $.getJSON('/schedule', function(data){
          data.forEach(function(item){
            delete item['id']
            schedule[item.name] = item
          })
          loadPatients();
          displaySchedule();
        })
      }

      function createSeries(event){

        // add series
        var freq = event.data['freq'];
        [-2,-1,1,2,3,4,5].forEach(function(i){
          var start = moment(event.start);
          var end = moment(event.end);
          start.add(i*freq,'day')
          end.add(i*freq,'day')
          d = {
            title: event.title,
            start: start,
            className: getClassNameForFreq(freq),
            end: end,
            data: event.data,
          }
          $('#calendar').fullCalendar('renderEvent', d, true);
        })
      }

      function displaySchedule(){

        var cal = $('#calendar')

        cal.fullCalendar('removeEvents', function(e){return true});

        var view = cal.fullCalendar('getView')

        for (var k in schedule){
          item = schedule[k]

          var d = moment(item.moment).diff(view.start,'day')
          if (d < 0){d = d-1} // not clear why this is needed
          d = d%item.freq
          var start = moment(view.start).add(d,'day')
          var event = {
            title: item.name,
            className: getClassNameForFreq(item.freq),
            start: moment(start.format()+"T"+item.start),
            end: moment(start.format()+"T"+item.end),
            data:{freq: item.freq, pid: item.pid},
            stick: true,
          }
          cal.fullCalendar('renderEvent',event,true)
          createSeries(event)
        }
      }

      function addPatientDiv(event){

            freq = event.data.freq;
            var className = getClassNameForFreq(freq);

            event_cond = {
              title: event.title,
              data: event.data,
              className: className,
              allDay: false,
              stick: true,
            }

            var btn = $("<span class='badge-pill' onclick='badge(this);'></span")
              .addClass((className=='weekly'?'bi-weekly':'weekly'))
              .text((freq==7? 14:7))

            var div = $('<div></div>')
              .addClass('fc-event patient ' + className)
              .text(event.title)
              .data('event', event_cond) 
              .draggable()
              .append(btn)

            $('#external-events').append(div)
      }

      function loadPatients(){

        $.getJSON('/patient', function(data){

          data = data.patient_list.filter(function(item){return !(item.name in schedule)})

          $('#external-events div.patient').remove()
          data.forEach(function(item){

            addPatientDiv({
              title: item.name,
              data: {freq: 7, pid: item.id},
            })
          })
        })
      }

      function saveSchedule(){
        // first clears old schedule, then stores current entries
        $.post('/schedule',{'clear':true}, function(r){
          if (r == 'cleared'){
            for (var k in schedule){
              s = schedule[k]
              $.post('/schedule',s,function(r){
                console.log("success " + r)
              })
            }
          }
          else {
            alert('save failed')
          }     
        })
      }

      function clearSchedule(){

        var cal = $('#calendar');
        cal.fullCalendar('removeEvents', function(e){return true});
        cal.fullCalendar('render');
        // disregards scrollTime option.
        // fix: switch views and back
        cal.fullCalendar('changeView',"month");
        cal.fullCalendar('changeView',"agendaBiWeekly");
        schedule = {};
        loadPatients();
      }

      function sameTitle(event){
        return function(e){
          return e.title == event.title;
        }
      }
      function notSame(event){
        return function(e){
          return e._id != event._id;
        }
      }

      $(function() {

        load();

        // initialize the calendar
        // -----------------------------------------------------------------

        $('#calendar').fullCalendar({
          header: {
            left: 'prev,next',
            center: 'title',
            right: 'agendaBiWeekly,month'
          },
          views: {
            agendaBiWeekly: {
              type: 'agenda',
              duration: { days: 14 },
              buttonText: 'week'
            }
          },       

          columnHeaderFormat: 'ddd',
          themeSystem: 'bootstrap3',
          weekends: false,
          defaultView: 'agendaBiWeekly',
          allDaySlot: false,
          minTime: "07:00:00",
          maxTime: "23:00:00",
          scrollTime: "16:00:00",
          slotDuration: "00:15:00",
          eventLimit: true,
          editable: true,
          droppable: true,

          eventClick: function(event, element) {

            $('#calendar').fullCalendar('removeEvents', sameTitle(event));

            addPatientDiv(event)
            delete schedule[event.title];
          },
          eventResize: function(event, dl){

            $('#calendar').fullCalendar('clientEvents')
              .filter(sameTitle(event))
              .filter(notSame(event))
              .forEach(function(e){
                e.end.add(dl);
                
                $('#calendar').fullCalendar('updateEvent', e);
              })

              addEvent(event)
          },
          eventDrop: function(event, dl){

            $('#calendar').fullCalendar('clientEvents')
              .filter(sameTitle(event))
              .filter(notSame(event))
              .forEach(function(e){
                e.start.add(dl);
                e.end.add(dl);
                
                $('#calendar').fullCalendar('updateEvent', e);
              })

              addEvent(event)
          },
          drop: function(mom) {

            d = $(this).data('event');

            // add series
            var freq = d.data['freq'];
            [-2,-1,1,2,3,4,5].forEach(function(i){
              var m = moment(mom)
              m.add(i*freq,'day')
              d['start'] = m
              end_time = moment(m);
              end_time.add(45,'minute');
              d['end'] = end_time;
              $('#calendar').fullCalendar('renderEvent', d, true);
            })

            // remove from list of external events
            $(this).remove();

          },
          eventReceive: function(event){
            end_time = moment(event.start);
            end_time.add(45,'minute');
            event.end = end_time;
            $('#calendar').fullCalendar('updateEvent', event);
            addEvent(event);
          }
        });

      });

    </script>

  </body>
</html>