<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>MyTherapyNotes</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">  

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/css/bootstrap-datepicker.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.min.css" />

    <link rel="stylesheet" href="js/lmhc.css"/>

  </head>

  <body>
    <nav class="navbar navbar-default navbar-static-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="true" aria-controls="navbar">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">
            <p>MyTherapyNotes</p>
          </a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a onclick="todoPage();">Workflows</a></li>
            <li><a onclick="patientPage()">Patients</a></li>
            <li><a onclick="historyPage();">History</a></li>
            <li><a onclick="billingPage();">Billing</a></li>
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="#">Other <span class="caret"></a>
              <ul class="dropdown-menu">
                <li class="dropdown-item"><a href="static/schedule.html">Schedule</a></li>
                <li class="dropdown-item"><a href="static/printing.html">Printing</a></li>
                <li class="dropdown-item"><a id="import" href="static/import.html">Import</a></li>
                <li class="dropdown-item"><a id="icd10" href="static/icd10.html" target="_blank">ICD-10 tool</a></li>
                <li class="dropdown-item"><a href="{{ url|safe }}">{{ url_linktext }}</a></li>
              </ul>
            </li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <!--<li class="active"><a href="{{ url|safe }}">{{ url_linktext }}</a></li>-->
            <li><a disabled>
              {% if user %}
                {{user.email()}}
              {% endif %}
            </a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
{% if waiver %}
<div class="container " id="waiverPage">
  <div class="row">
    <div class="col-sm-offset-1 col-sm-10">
      <h1>
        Waiver
      </h1>
      <p class="lead">
        In no event, unless required by applicable law or agreed to in writing, shall the makers of mytherapynotes.com, or any person associated with mytherapynotes.com be liable for any loss, expense or damage, of any type or nature arising out of the use of, or inability to use this software or program, including, but not limited to, claims, suits or causes of action involving alleged infringement of copyrights, patents, trademarks, trade secrets, or unfair competition.
      </p>
      <p class="lead">
        The makers of mytherapynotes.com make no warranty that
      </p>
      <p>
      <ul class="lead">
        <li>The software will meet your requirements.</li>
        <li>The software will be uninterrupted, timely, secure or error-free.</li>
        <li>The results that may be obtained from the use of the software will be effective, accurate or reliable.</li>
        <li>The quality of the software will meet your expectations.</li>
        <li>Any errors in the software will be corrected.</li>
      </ul>
    </p>
      <a href="/email">Accept</a>
    </div>
  </div>
</div>
{% elif permission %}
    
    <div class="contaier" id="patientPage">

      <div class="row">
        <div class="col-sm-offset-1 col-sm-5">
          <div id="patient_display"> 
            <div class="input-group">
              <input class="form-control" id="patientSearchInput" type="text" placeholder="Search..">
              <span class="input-group-addon" aria-hidden="true">
                <a onclick="$('#patientSearchInput').val('');$('#patientSearchInput').keyup();">&times;</a>
              </span>
              <span class="input-group-addon" aria-hidden="true">
                <a id="inactive" onclick="$('#patientSearchInput').val('');toggle_inactive();">active</a>
              </span>
            </div>
            <br/>
            <table id="patientTable" class="table table-bordered table-striped">
              <thead hidden>
                <th></th>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-sm-offset-1 col-sm-10">
          <button id="new-patient" type="button" class="btn btn-default" onclick="new_patient()">New</button>
        </div>
      </div>
    </div>

    <div class="container" id="historyPage">
      <div class="row">
        <div class="col-sm-10">
          <div id="calendar"> </div>
        </div>
      </div>
    </div>

    <div class="container" id="billingPage">
      <div class="row billing-what">
        <div class="col-sm-offset-1 col-sm-5">
          <label for="#billing-date">Date:</label>
          <input type="text" id="billing-date" name="billing-date"/>
        </div>
      </div>
      <div class="row billing-what">
        <div class="spacer20"></div>
      </div>
      <div class="row billing-what">
        <div class="col-sm-offset-1 col-sm-5">
          <div class="button-group" role="group">
            <button type="button" class="btn btn-primary btn-xs" onclick="getCSV();">CSV</button>
            <button type="button" class="btn btn-primary btn-xs" onclick="getPDF();">PDF</button>
            <button type="button" class="btn btn-danger btn-xs" onclick="confirmEmail();">Mail</button>
          </div>
        </div>
      </div>

      <div class="row confirm-email">
        <div class="col-sm-offset-1 col-sm-5">
          <br/>
          <div class="alert alert-danger" role="alert">
            Sending a final email is not reversible. The action marks sessions as billed.
          </div>
        </div>
      </div>
      <div class="row confirm-email">
        <div class="col-sm-offset-1 col-sm-5">
          <div class="button-group" role="group">
            <button type="button" class="btn btn-primary btn-xs" onclick="billingPage();">Cancel</button>
            <button type="button" class="btn btn-danger btn-xs" onclick="sendBillingEmail();">Confirm</button>
          </div>
        </div>
      </div>

      <div class="row ack-email">
        <div class="col-sm-offset-1 col-sm-5">
          <br/>
          <div id="ack-message" class="alert" role="alert">
          </div>
        </div>
      </div>

    </div>

    <div id="todoPage">
      <div class="container">
        <div class="row" id="todo-what">
          <div class="col-sm-6">
            <button type="button" class="btn btn-default btn-lg btn-block" onclick="patientPage();">Add session</button>
            <button type="button" class="btn btn-default btn-lg btn-block" onclick="historyPage();">Edit session</button>
            <button type="button" class="btn btn-default btn-lg btn-block" onclick="addTodos();">Add to-do's</button>
            <button type="button" class="btn btn-default btn-lg btn-block" onclick="finishTodos();">Finish to-do's</button>
          </div>
        </div>

        <div class="row" id="todo-add">
          <div class="col-sm-6">
            <div id="todo">
              <label for="#todo-date">Date:</label>
              <input type="text" id="todo-date"/>
            </div>
          </div>
        </div>
      </div>

      <div class="container" id="todoResults">
        <div class="row">
            <div class="spacer20"></div>
        </div>
        <div class="row">
          <div class="col-sm-6" >
            <div class="panel panel-default" id="eligible-panel">
              <div class="panel-heading">
                <p class="mylead" id="eligible">No eligible patients on this date</p>
              </div>
            </div>
            <!--<div id='XXX'><p>ppp</p><p>qqq</p></div>-->
            <ul class="list-group" id="todo-patients-list">
              <template id="todo-patient-list-tmpl">
                <div id="PID">
                  <li class="list-group-item lead list-group-item-info">
                    <a>title</a>
                    <span role="button"
                    class="delete-session glyphicon glyphicon-minus-sign badge-pill"
                    data-toggle="tooltip" title="Click to delete session"></span>
                    <span role="button"
                    class="add-note glyphicon glyphicon-align-justify badge-pill"
                    data-toggle="tooltip" title="Click to add notes"></span>
                    <span role="button"
                    class="add-note-img glyphicon glyphicon-picture badge-pill"
                    data-toggle="tooltip" title="Click to add notes img"></span>
                  </li>
                  <form action="/" 
                    enctype="multipart/form-data"
                    method='post'>
                      <input name="pid" class="data-ro" hidden >
                      <input name="sid" class="data-ro" hidden >
                      <input name="date" class="data-ro" hidden >
                        <div class="notes-area collapse ">
                          <textarea class="form-control" rows=5 name="notes-todo"></textarea>
                        </div>
                        <div class="notes-area notes-area-img collapse ">
                          <input type="file" accept="image/*" name="img-file-todo">
                        </div>
                  </form>
                  <!--
                  <div class="notes-area collapse ">
                    <textarea class="form-control" rows=5></textarea>
                  </div>
                  <div class="notes-area collapse " id="PID-notes">
                    <input type="file" name="add-img-file" id="add-img-file">
                  </div>
                -->
                </div>
              </template>
            </ul>
          </div>
        </div>

        <div class="row">
          <div class="col-sm-6" id="todo-patients-submit">
            <button class="btn btn-xs btn-primary" onclick="validate_submit_todos();">Submit</button>
          </div>
        </div>

        <div class="row confirm-todo">
          <div class="col-sm-6">
            <br/>
            <div class="alert alert-danger" role="alert" id="todo-warning">
              This will create X new sessions. This action is not reversible.
            </div>
          </div>
        </div>
        <div class="row confirm-todo">
          <div class="col-sm-6" id="confirm-todo-btn">
            <div class="button-group" role="group">
              <button type="button" class="btn btn-primary btn-xs" onclick="todoPage();">Cancel</button>
              <button type="button" class="btn btn-danger btn-xs" onclick="submit_todos();">Confirm</button>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-sm-6" id="todo-again">
            <button class="btn btn-xs btn-primary" onclick="todoPage();">More</button>
          </div>
        </div>
      </div>
    </div>


    <!-- session modal -->
    <div class="modal fade bs-example-modal-lg" id="session_info" tabindex="-1" role="dialog" aria-labelledby="sessionInfoLabel" data-backdrop="static" data-keyboard="false">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" id="session-info-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <span class="glyphicon glyphicon-print badge-pill" id="session-print" onclick="printSession();"></span>
            <span class="glyphicon glyphicon-upload badge-pill" id="sessionSubmit" onclick="submit_session();"></span>
            <span class="glyphicon glyphicon-edit badge-pill" id="sessionEdit" onclick="edit_session();"></span>

            <h4 class="modal-title" id="sessionInfoLabel">Session</h4>
          </div>
          <div class="modal-body">   
            <form id="new_session_form" action="/sessions" 
                  enctype="multipart/form-data"
                  method='post'>
              <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">

                <!-- PI -->
                <div class="panel panel-default">
                  <div class="panel-heading" role="tab" id="headingPI">
                    <h4 class="panel-title">
                      <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapsePI" aria-expanded="true" aria-controls="collapsePI">
                        Patient info
                      </a>
                    </h4>
                  </div>
                  <div id="collapsePI" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingPI">
                    <div class="panel-body">
                      <ul class="SI-group list-group">
                        <li class="list-group-item">
                          <div class="input-group">
                            Name: <input type="text" id="name" name="name" class="data-ro">
                          </div>
                        </li>
                        <li class="list-group-item">
                          <div class="form-row">
                            DOB: <input id="dob" name="dob" class="data-ro" >
                            <input id="insurance" name="insurance" class="data-ro" hidden >
                            <input id="patient_id" name="patient_id" class="data-ro" hidden>
                            <input id="session_id" name="session_id" class="data-ro" hidden>
                          </div>
                        </li>
                        <li class="list-group-item">
                          <div class="input-group">
                            Primary diagnosis: <input type="text" id="diag" name="diag" >
                            Primary diagnosis code: <input type="text" id="diag_code" name="diag_code" >
                            <a href="/static/icd10.html" target="_blank" class="glyphicon glyphicon-search badge-pill"></a>
                          </div>
                        </li>
                        <li class="list-group-item">
                          <div class="input-group">
                            Secondary diagnosis: <input type="text" id="diag_2" name="diag_2" >
                            Secondary diagnosis code: <input type="text" id="diag_2_code" name="diag_2_code" >
                          </div>
                        </li>                        
                      </ul>
                    </div>
                  </div>
                </div>
                
                <!-- SI -->
                <div class="panel panel-default">
                  <div class="panel-heading" role="tab" id="headingSI">
                    <h4 class="panel-title">
                      <a id="a-SI" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseSI" aria-expanded="false" aria-controls="collapseSI">
                        Session info
                      </a>
                    </h4>
                  </div>
                  <div id="collapseSI" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingSI">
                    <div class="panel-body">
                      <ul class="SI-group list-group">
                        <li class="list-group-item">
                          <div class="input-group">
                            Date: <input id="seshdate" name="date" class="non-editable">
                            <div class="input-group-append">
                                <input type="checkbox" name="to-do" id="to-do">
                                <span class="input-group-text">TODO</span>


                                <input type="checkbox" name="notes-attached" id="notes-attached">
                                <span class="input-group-text">Attached</span>
                                <input type="file" accept="image/*" name="img-file" id="img-file">


                            </div>
                          </div>
                        </li>
                        <li class="list-group-item">
                        Session #: <input type="text" id="seshNo" name="seshNo" class="data-ro" >
                        </li>
                        <li class="list-group-item">
                          Modality:
                          <select id="modality" name="modality">
                            <option id="ind45" value="Individual-45min">Individual-45min</option>
                            <option id="ind30" value="Individual-30min">Individual-30min</option>
                            <option id="ind60" value="Individual-60min">Individual-60min</option>
                            <option id="fam" value="Family with patient">Family with patient</option>
                            <option id="fwo" value="Family without patient">Family without patient</option>
                            <option id="grp" value="Group">Group</option>
                            <option id="eval" value="Evaluation">Evaluation</option>
                            <option id="oth" value="Other">Other</option>
                          </select>
                          <input id="mod_code_input" type="text" name="mod_code" placeholder="Procedure code" hidden>
                        </li>
                        <li class="list-group-item">
                          <p class="help-block">New issue</p>
                          <div class="input-group">
                            <div class="input-group-prepend">
                                <input type="checkbox" name="no_new_issue" id="no_new_issue">
                                <span class="input-group-text">None reported</span>
                            </div>
                            New:
                            <input type="text" name="new_issue" id="new_issue" class="form-control">
                          </div>
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>

                <!-- RA -->
                <div class="panel panel-default">
                  <div class="panel-heading" role="tab" id="headingRA">
                    <h4 class="panel-title">
                      <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseRA" aria-expanded="false" aria-controls="collapseRA">
                        Risk assessment
                      </a>
                    </h4>
                  </div>
                  <div id="collapseRA" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingRA">
                    <div class="panel-body">
                      <ul class="SI-group list-group">
                        <li class="list-group-item">
                          <input type="checkbox" name="RA_none" id="RA_none"> Danger to none
                        </li>
                        <li class="list-group-item">
                          <table class="table table-responsive">
                            <thead>
                              <tr>
                                <th>Self</th>
                                <th>Others</th>
                                <th>Property</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr>
                                <td><input type="checkbox" name="RA_self_idea"> Ideation</td>
                                <td><input type="checkbox" name="RA_others_idea"> Ideation</td>
                                <td><input type="checkbox" name="RA_prop_idea"> Ideation</td>
                              </tr>
                              <tr>
                                <td><input type="checkbox" name="RA_self_plan"> Plan</td>
                                <td><input type="checkbox" name="RA_others_plan"> Plan</td>
                                <td><input type="checkbox" name="RA_prop_plan"> Plan</td>
                              </tr>
                              <tr>
                                <td><input type="checkbox" name="RA_self_att"> Attempted</td>
                                <td><input type="checkbox" name="RA_others_att"> Attempted</td>
                                <td><input type="checkbox" name="RA_prop_att"> Attempted</td>
                              </tr>
                            </tbody>
                          </table>
                        </li>
                      </ul>                   
                    </div>
                  </div>
                </div>

                <!-- TI -->
                <div class="panel panel-default">
                  <div class="panel-heading" role="tab" id="headingTI">
                    <h4 class="panel-title">
                      <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseTI" aria-expanded="false" aria-controls="collapseTI">
                        Therapeutic Interventions
                      </a>
                    </h4>
                  </div>
                  <div id="collapseTI" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTI">
                    <div class="panel-body">
                      <ul class="SI-group list-group" id="TI-array">
                      </ul>
                    </div>
                  </div>
                </div>

                <!-- GO -->
                <div class="panel panel-default">
                  <div class="panel-heading" role="tab" id="headingGO">
                    <h4 class="panel-title">
                      <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseGO" aria-expanded="false" aria-controls="collapseGO">
                        Goals
                      </a>
                    </h4>
                  </div>
                  <div id="collapseGO" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingGO">
                    <div class="panel-body">
                      <ul class="SI-group list-group">
                        <li class="list-group-item">
                          <table class="table table-responsive">
                            <tbody>
                              <tr>
                                <td>
                                  <div class="input-group">
                                    <div class="input-group-prepend">
                                        <input type="checkbox" name="G_1_impr" id="G_1_impr">
                                        <span class="input-group-text">Improve</span>
                                    </div>
                                    <input type="text" name="G_1_impr_txt" id="G_1_impr_txt" class="form-control">
                                  </div>
                                </td>
                                <td>
                                  <div class="input-group">
                                    <div class="input-group-prepend">
                                        <input type="checkbox" name="G_1_decr" id="G_1_decr">
                                        <span class="input-group-text">Decrease</span>
                                    </div>
                                    <input type="text" name="G_1_decr_txt" id="G_1_decr_txt" class="form-control">
                                  </div>
                                </td>
                              </tr>
                              <tr>
                                <td>
                                  <div class="input-group">
                                    <div class="input-group-prepend">
                                        <input type="checkbox" name="G_2_impr" id="G_2_impr">
                                        <span class="input-group-text">Improve</span>
                                    </div>
                                    <input type="text" name="G_2_impr_txt" id="G_2_impr_txt" class="form-control" >
                                  </div>
                                </td>
                                <td>
                                  <div class="input-group">
                                    <div class="input-group-prepend">
                                        <input type="checkbox" name="G_2_decr" id="G_2_decr">
                                        <span class="input-group-text">Decrease</span>
                                    </div>
                                    <input type="text" name="G_2_decr_txt" id="G_2_decr_txt" class="form-control" >
                                  </div>
                                </td>
                              </tr>
                              <tr>
                                <td>
                                  <div class="input-group">
                                    <div class="input-group-prepend">
                                        <input type="checkbox" name="G_3_impr" id="G_3_impr">
                                        <span class="input-group-text">Improve</span>
                                    </div>
                                    <input type="text" name="G_3_impr_txt" id="G_3_impr_txt" class="form-control" >
                                  </div>
                                </td>
                                <td>
                                  <div class="input-group">
                                    <div class="input-group-prepend">
                                        <input type="checkbox" name="G_3_decr" id="G_3_decr">
                                        <span class="input-group-text">Decrease</span>
                                    </div>
                                    <input type="text" name="G_3_decr_txt" id="G_3_decr_txt" class="form-control" >
                                  </div>
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </li>
                      </ul>
                        
                      <ul class="SI-group list-group" id="Goals-array">  
                      </ul>
                    </div>
                  </div>
                </div>

                <!-- SPA -->
                <div class="panel panel-default">
                  <div class="panel-heading" role="tab" id="headingSPA">
                    <h4 class="panel-title">
                      <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseSPA" aria-expanded="false" aria-controls="collapseSPA">
                        Symptoms / Problem Areas
                      </a>
                    </h4>
                  </div>
                  <div id="collapseSPA" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingSPA">
                    <div class="panel-body">
                      <ul class="SI-group list-group" id="SPA-array">
                      </ul>
                    </div>
                  </div>
                </div>

                <!-- notes -->
                <div class="panel panel-default">
                  <div class="panel-heading" role="tab" id="headingNO">
                    <h4 class="panel-title">
                      <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseNO" aria-expanded="false" aria-controls="collapseNO">
                        Notes
                      </a>
                    </h4>
                  </div>
                  <div id="collapseNO" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingNO">
                    <div class="panel-body">
                      <div class="form-group">
                        <!--<div class="input-group-prepend">
                          <input type="checkbox" name="notes-attached" id="notes-attached">
                          <span class="input-group-text">Attached</span>
                          <input type="file" name="img-file" id="img-file">
                        </div>-->
                        <textarea class="form-control" rows="5" id="notes" name="notes"></textarea>
                        <div class="pre-scrollable" id="img-notes"></div>
                      </div>                      
                    </div>
                  </div>
                </div>

                <!-- ASS -->
                <div class="panel panel-default">
                  <div class="panel-heading" role="tab" id="headingASS">
                    <h4 class="panel-title">
                      <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseASS" aria-expanded="false" aria-controls="collapseASS">
                        Assessment
                      </a>
                    </h4>
                  </div>
                  <div id="collapseASS" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingASS">
                    <div class="panel-body">
                      <ul class="SI-group list-group">
                        <li class="list-group-item">
                          <select id="ASS_CONST" name="ASS_CONST">
                            <option value="NA">N/A</option>
                            <option value="Did">Did</option>
                            <option value="DidNot">Did not</option>
                          </select>
                          use session constructively to address problem areas.
                        </li>
                        <li class="list-group-item">
                          <select id="ASS_INSIG" name="ASS_INSIG" >
                            <option value="NA">N/A</option>
                            <option value="Did">Did</option>
                            <option value="DidNot">Did not</option>
                          </select>
                          show insightfulness.
                        </li>
                        <li class="list-group-item">
                          <select id="ASS_EFFRT" name="ASS_EFFRT" >
                            <option value="NA">N/A</option>
                            <option value="Did">Did</option>
                            <option value="DidNot">Did not</option>
                          </select>
                          show effort in addressing problem areas.
                        </li>
                        <li class="list-group-item">
                          <select id="ASS_OR" name="ASS_OR" >
                            <option value="NA">N/A</option>
                            <option value="Was">Was</option>
                            <option value="WasNot">Was not</option>
                          </select>
                          oriented times 3.
                        </li>

                        <li class="list-group-item">
                          <div class="input-group">
                            <div class="input-group-prepend">
                                <select id="ASS_present" name="ASS_present" >
                                  <option value="NA">N/A</option>
                                  <option value="Did">Did</option>
                                  <option value="DidNot">Did not</option>
                                </select>
                                <span class="input-group-text">present with</span>
                            </div>
                            <input type="text" id="ASS_present_txt" name="ASS_present_txt" class="form-control">
                            <span class="input-group-text">symptoms in session</span>

                          </div>
                        </li>

                        <li class="list-group-item">
                          <select id="ASS_ABLE" name="ASS_ABLE" >
                            <option value="NA">N/A</option>
                            <option value="Was">Was</option>
                            <option value="WasNot">Was not</option>
                          </select>
                          able to talk about stress factors and how to better manage them.
                        </li>
                        <li class="list-group-item">
                          <select id="ASS_COOP" name="ASS_COOP" >
                            <option value="NA">N/A</option>
                            <option value="Was">Was</option>
                            <option value="WasNot">Was not</option>
                          </select>
                          cooperative with therapist's efforts to assist him/her with problem areas.
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
              
                <!-- PLN -->
                <div class="panel panel-default">
                  <div class="panel-heading" role="tab" id="headingPLN">
                    <h4 class="panel-title">
                      <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapsePLN" aria-expanded="false" aria-controls="collapsePLN">
                        Plan
                      </a>
                    </h4>
                  </div>
                  <div id="collapsePLN" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingPLN">
                    <div class="panel-body">
                      <ul class="SI-group list-group">
                        <li class="list-group-item">
                          Continue
                          <select id="PLN_CONT" name="PLN_CONT" >
                            <option value="Individual">individual</option>
                            <option value="Other">other</option>
                          </select>
                          on a 
                          <select id="PLN_FREQ" name="PLN_FREQ" >
                            <option value="Weekly">weekly</option>
                            <option value="Bi-weekly">bi-weekly</option>
                            <option value="Monthly">monthly</option>
                            <option value="TwoX">twoX-weekly</option>
                            <option value="ThreeX">threeX-weekly</option>
                            <option value="FourX">fourX-weekly</option>
                          </select>
                          basis to work through and develop coping skills to address problem areas.
                        </li>
                        <li class="list-group-item">
                          <input type="checkbox" id="PLN_PSY" name="PLN_PSY"> Continue psychiatric meditations as directed by doctor.
                        </li>
                        <li class="list-group-item">
                          Next session date: 
                          <input type="text" id="PLN_NXT" name="PLN_NXT"> 
                        </li>

                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>

          <!--
          <div class="modal-footer">
            <button id="sessionSubmit" type="button" class="btn btn-default" onclick="submit_session()">Submit</button>
            <button id="sessionEdit" type="button" class="btn btn-default" onclick="edit_session()">Edit</button>
          </div>-->

        </div>
      </div>
    </div>   

    <!-- Patients modal -->
    <div class="modal fade bs-example-modal-lg" id="patientForm" tabindex="-1" role="dialog" >
      <div class="modal-dialog modal_lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="patient_form modal-title" id="patientFormLabel">New patient</h4>
          </div>
          <div class="modal-body">
  
              <div class="patient_form">
                <form id="new_patient_form" action="/patient" method="post">
                  <input id="patientFormPID" name="patient_id" hidden>

                  <div class="form-group">
                    <input name="name" type="text" class="form-control" id="nameInput" placeholder="name">
                  </div>
                  <div class="form-group date">
                    <input name="dob" id="dob-date" type="text" class="form-control" name="dob" placeholder="dob">
                  </div>
                  <div class="form-group">
                    <select name="insurance" class="form-control" id="insurance" placeholder="insurance">
                      <option>BlueCrossBlueShield</option>
                      <option>Tufts</option>
                      <option>HarvardPilgrim</option>
                      <option>Optum</option>
                      <option>Cypress</option>
                      <option>Cigna</option>
                      <option>None</option>
                      <option>SelfPay</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <input name="session_number" type="text" class="form-control" id="session_number" placeholder="session number">
                  </div>
                  <div class="form-group">
                    <select name="status" class="form-control" id="status" placeholder="status">
                      <option>Active</option>
                      <option>Inactive</option>
                    </select>
                  </div>
                </form>
              </div>            

          </div>
          <div class="modal-footer">
            <button id="submit-patient" type="button" class="patient_form btn btn-default" onclick="submit_patient()">Submit</button>
          </div>
        </div>
      </div>
    </div>

    <!-- notes modal -->
    <div class="modal fade bs-example-modal-lg" id="notesList" tabindex="-1" role="dialog" >
      <div class="modal-dialog modal_lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="notes_display modal-title" id="notesListLabel">Notes</h4>
          </div>
          <div class="modal-body"> 
            <div id="notesCalendar"> </div>
          </div>     
        </div>
      </div>
    </div>

{% else %}
<div class="container">
  <div class="row">
    <div class="col-sm-5 col-sm-offset-1">
      <h3>This account does not have the proper permissions.</h3>
      <br/>
      <a href="{{ url|safe }}">Switch accounts</a> 
    </div>
  </div>
</div>
{% endif %}

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script
      src="https://code.jquery.com/jquery-3.3.1.min.js"
      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
      crossorigin="anonymous"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/js/bootstrap-datepicker.min.js' type='text/javascript'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.1.1/d3.min.js"></script>

    <script src="js/codes.js"></script>

    <script>

      Codes.load();

      var new_patient_flag = true;
      var new_session_flag = true;

      function toggle_inactive(){
        // if #inactive text == active, then we are displaying both, and vice versa
        inactive = $('#inactive');
        if (inactive.text()=='active'){
          $("#patientTable tr").filter(function() {
            $(this).toggle(!$(this).hasClass('inactive'));
          });
          $('#inactive').text('inactive');
        }
        else{
          $("#patientTable tr").show();
          $('#inactive').text('active');
        }
      }

      function printSession(){
        window.open('/print?sid='+$('#session_id').val())
      } 

      function validateBillingDate(date){
        if (date == ''){
          alert('must specify billing date')
          return false
        }
        return true
      }

      function getCSV(){
        var date = $('#billing-date').val()
        if (!validateBillingDate(date)){
          return
        }
        window.open('/bill?type=csv&end='+date)
      }

      function getPDF(){
        var date = $('#billing-date').val()
        if (!validateBillingDate(date)){
          return
        }
        window.open('/bill?type=pdf&end='+date)
      }

      function confirmEmail(){
        var date = $('#billing-date').val()
        if (!validateBillingDate(date)){
          return
        }
        $('.confirm-email').show()
      }

      function sendBillingEmail(){
        var date = $('#billing-date').val()

        // refresh to display billed sessions
        new_session_flag = true;

        $.getJSON('/bill?type=pdf&email=true&mark=true&end='+date, function(data){
          //console.log(data)
          $('.billing-what').hide()
          $('.confirm-email').hide()
          $('.ack-email').show()
          var status = data.status
          var msg = ''
          var _class = ''
          if (status == 'success'){
            msg = 'Email was sent succesfully.  Bill contains ' + data.no_sessions + ' billable sessions.'
            _class = "alert-success"
          }
          else {
            msg = "No email was sent. No billable sessions found in the date range."
            _class = "alert-warning"
          }
          $('#ack-message').text(msg).addClass(_class)
        })
      }

      function billingPage(){
        $('#patientPage').hide()
        $('#historyPage').hide()
        $('#billingPage').show()
        $('#todoPage').hide()

        $('.billing-what').show()
        $('.confirm-email').hide()
        $('.ack-email').hide()

        $('#billing-date').val('')
        $('#billing-date').datepicker({
              autoclose: true,
              todayHighlight: true,
          });

      }

      function patientPage(){
        $('#patientPage').show()
        $('#historyPage').hide()
        $('#billingPage').hide()
        $('#todoPage').hide()

        load_patients();
      }

      function historyPage(){
        $('#patientPage').hide()
        $('#historyPage').show()
        $('#billingPage').hide()
        $('#todoPage').hide()


        load_sessions();
      }

      function addTodos(){

        finish_todo_flag = false;
        add_todo_flag = true;

        $('#todo-what').hide();
        $('#todo-add').show();

        $('#todo-date').val('');
        $('#todo-date').datepicker({
              autoclose: true,
              todayHighlight: true,
              endDate: new Date(),
          });

        $('#todo-patients-list > div').remove()

        $('#todo-date').unbind('change');
        $('#todo-date').change(function(){
          get_patients_for_todo($(this).val())
        })
      }

      function remove_todo_patient(el){
        var li = $(el).parent();
        $(li).next().remove();
        $(li).remove();

        var items = $('#todo-patients-list li').length;
        if (items == 0){
          todoPage();
        }
      }

      function finishTodos(){

        finish_todo_flag = true;
        add_todo_flag = false;

        $('#todo-what').hide();

        $('#todo-patients-list > div').remove()
        $('#eligible').unbind('click')

        $.getJSON('/sessions?order=fifo', function(data){

          console.log('date # records = ' + data.length);
          todos = data.filter((item) => item.notes == "TODO")
          //console.log(todos);

          if (todos.length == 0){
            $('#eligible, #eligible-panel').show();
            $('#eligible').text("Congratulations! No to-do's")
            $('#eligible').click(todoPage);

            $('#todo-patients-list, #todo-patients-submit').hide();
            return;
          }

          $('#eligible, #eligible-panel').hide()
          $('#todo-patients-list, #todo-patients-submit').show()

          todos.forEach(add_tmpl_for_patient);

          // on click will remove the patient
          $('.delete-session').click(function(){
            remove_todo_patient(this);
          })
        })
      }

      function display_todo_session(el){

        // mimic calendar event
        calendarEventClick({'data': $(el).data()})
        d3.select('#sessionEdit')
          .classed('visible',null)
          .classed('invisible',true)
      }

      function todoPage(){
        $('#patientPage').hide()
        $('#historyPage').hide()
        $('#billingPage').hide()
        $('#todoPage').show()

        $('#todo-what').show()
        $('#todo-add').hide()
        $('#todo-finish').hide()
        $('#todo-again').hide()

        $('#eligible, #eligible-panel').hide()
        $('#todo-patients-list, #todo-patients-submit').hide()
        $('.confirm-todo').hide()

        var add_todo_flag = false;
        var finish_todo_flag = false;
      }

      function eligible(date) {

        return function(item){
          var mom_schedule = moment(item.moment);
          mom_schedule.set('hour',0);
          mom_schedule.set('minute',0);
          mom_schedule.set('second',0);
          var d = moment(date, "MM/DD/YYYY").diff(mom_schedule,'day');
          return d % item.freq == 0;
        }
      }

      function collapse_notes(id){

        return function(e){
          $('#'+id).collapse('toggle');
          e.stopPropagation();
        }
      }

      function collapse_image(id){

        return function(e){
          $('#'+id).collapse('toggle');
          e.stopPropagation();
        }
      }

      function add_tmpl_for_patient(item) {
        //console.log(item)
        var tmp  = $( $('#todo-patient-list-tmpl').html() );
        tmp.attr('id',item.id);
        var li = tmp.find('li').first();

        // only schedule items have pid
        if (item.pid){
          li.attr('pid', item.pid);
        }
        // hack. if item.date is defined, it means it is a session reecord
        // else, it is a shcedule record
        if (item.date){
          li.attr('sid', item.id);
        }
        var title = `<small>${item.name}</small>`
        if (item.date){
          title = `<small>${item.name}: ${item.date}</small>`
        }
        li.find('a').first().html(title);

        tmp.find('form').first().attr('id', item.id+'-form')

        var form = tmp.find('form').first()
        form.attr('sid',item.id)
        form.find('input[name="pid"]').first().val(item.patient_id)
        form.find('input[name="sid"]').first().val(item.id)
        form.find('input[name="date"]').first().val(item.date)

        var notes = item.id+'-notes'
        tmp.find('.notes-area').first().attr('id', notes)

        var img = item.id+'-img'
        tmp.find('.notes-area-img').attr('id', img)

        tmp.clone().appendTo('#todo-patients-list')
        if (item.date){
          $(`#${item.id} span.add-note`).click(collapse_notes(notes))
          $(`#${item.id} span.add-note-img`).click(collapse_notes(img))
        }
        else {
          $(`#${item.id} span.add-note`).remove();
          $(`#${item.id} span.add-note-img`).remove();
        }
        $(`#${item.id} a`).first().data(item)
          .click(function(){display_todo_session(this)});
      }

      function get_patients_for_todo(date){

        $('#todo-patients-list > div').remove()

        if (date != ''){

          $.getJSON('/schedule',function(schedule){

            var eligible_items = schedule.filter(eligible(date));
            if (eligible_items.length == 0){
              $('#eligible, #eligible-panel').show();
              $('#eligible').text('No eligible patients on this date')
              $('#todo-patients-list, #todo-patients-submit').hide();
              return;
            }

            $('#eligible, #eligible-panel').hide()
            $('#todo-patients-list, #todo-patients-submit').show()

            eligible_items.forEach(add_tmpl_for_patient);

            // unbind click for <a>. Nothing to display
            $('#todo-patients-list a').unbind('click')
              .click(function(e){e.stopPropagation();})

            // on click will remove the patient
            $('.delete-session').click(function(){
              remove_todo_patient(this);
            })
          })
        }
      }

      function validate_submit_todos(){

        $('#todo-patients-submit').hide()
        $('.confirm-todo').show()
        $('#confirm-todo-btn').show();
        $('#todo-warning').unbind('click');
        //$('.add-note,.delete-session').remove();
        $('.delete-session').remove();
        $('.notes-area').collapse('hide')

        var no_patients = $('#todo-patients-list li').length;

        if (finish_todo_flag){
          // only valid sessions are sessions with non-trivial notes
          no_patients = 0
          $('#todo-patients-list li').each(function(){
            var form = $(this).next()
            var sid = form.attr('sid')

            var img = $(`#${sid}-img > input`).val()
            var notes = $(`#${sid}-notes > textarea`).val()

            if (notes != '' || img != ''){
              no_patients += 1;
            }
            else {
              $(this).remove()
            }
          });
        }

        if (no_patients == 0) {

          $('#todo-warning').text("No sessions were finished")
          $('#todo-again').show();
          $('#confirm-todo-btn').hide();
          return;
        }

        $('.notes-area').collapse('hide')

        $('#todo-warning').text(`This will create ${no_patients} new sessions. This action is not reversible.`)
      }

      function submit_todos(){

        function post_success(el){
          return function(r){
            r = $.parseJSON(r);
            //console.log(r)
            if (r.status == 'ok'){
              let span = $('<span class="glyphicon glyphicon-ok my-glyphicon-ok"></span>');
              span.attr('data-toggle','tootlip');
              if (r.latest){
                span.attr('title',`Latest session was on ${r.latest.date}. New session is number ${r.new_session.no_session}.`);
              }
              else {
                span.attr('title',`Updated session from ${r.new_session.date}.`);
              }
              span.tooltip();
              el.append(span);
              el.find('a').first().data(r.new_session);

              new_session_flag = true;
            }
            else {
              let span = $('<span class="glyphicon glyphicon-remove my-glyphicon-remove"></span>');
              span.attr('data-toggle','tooltip');
              span.attr('title',r.message);
              span.tooltip();
              el.append(span);
            }
          }
        }

        $('#todo-add, .add-note, .add-note-img').hide()
        $('.confirm-todo').hide()
        $('.notes-area').collapse('hide')

        $('#todo-patients-list li').unbind('click')
          .tooltip('hide');

        var date = $('#todo-date').val();
        $('#todo-patients-list li').each(function(){
          var el = $(this);

          var pid = el.attr('pid');
          var sid = el.attr('sid');

          var notes = '';
          var img = null;

          var form_data = new FormData(); 

          if (pid){
            notes = $(`#${pid}-notes textarea`).first().val()
            form_data.append("pid", pid)
            form_data.append("date", date)
          }
          if (sid){ 
            notes = $(`#${sid}-notes > textarea`).val()
            img = $(`#${sid}-img > input`).val()

            pid = $(`#${sid}-form > input[name="pid"]`).val()
            sid = $(`#${sid}-form > input[name="sid"]`).val()
            date = $(`#${sid}-form > input[name="date"]`).val()
            //console.log('posting todo', notes, img, name, date)

            if (img != ""){
              file_data = $(`#${sid}-img > input`).prop("files")[0]
              form_data.append("img-file-todo", file_data) 
            }
            form_data.append("pid", pid)
            form_data.append("sid", sid)
            form_data.append("date", date)
            form_data.append("notes-todo", notes)
          }


          if (pid || (notes && notes != '' || (img != ''))){
              $.ajax({
                url: '/new', 
                dataType: 'script',
                cache: false,
                contentType: false,
                processData: false,
                data: form_data, 
                type: 'post',
                success: post_success(el),
              })
          }
        })

        $('#todo-again').show();
      }

      // utility functions to handle different forms

      function setFormDisabled(id, value){
        d3.select(id)
          .selectAll('input')
          .attr('disabled',value);
        d3.select(id)
          .selectAll('select')
          .attr('disabled',value);
        d3.select(id)
          .selectAll('textarea')
          .attr('disabled',value);
      }

      function capitalize(string) {
          return string.charAt(0).toUpperCase() + string.slice(1);
      }

      function calendarEventClick(calEvent, jsEvent, view) {
        $("#new_session_form")[0].reset();
        populateSession(calEvent.data);
        d3.select('#sessionSubmit')
          .classed('visible',null)
          .classed('invisible',true)
        d3.select('#sessionEdit')
          .classed('visible',true)
          .classed('invisible',null)

        $('#notesList').modal('hide');
        $('#session_info').modal('show');
      }

      function display_patient_info(item){

        var form = d3.select('#new_patient_form');
        /*
        form.selectAll('.form-control')
          .attr('disabled',true);
        d3.select('#submit-patient')
          .attr('disabled',true);
          */
        d3.select('#patientFormLabel').text('Patient info');

        form.select('#patientFormPID').property('value',item['id']);
        form.select('#nameInput').property('value',item['name']);
        form.select('#dob-date').property('value',item['dob']);
        form.select('#insurance').property('value',item['insurance']);
        form.select('#session_number').property('value',item['session_number']);
        form.select('#status').property('value',item['status']);

        $('#patientForm').modal('show')
      }

      function submit_patient(){

        if ($('#dob-date').val() == ""){
          alert('dob cannot be empty');
          return
        }
        if ($('#nameInput').val() == ""){
          alert('name cannot be empty');
          return
        }

        document.getElementById("new_patient_form").submit();
      }

      function new_patient(){

        d3.select('#new_patient_form')
          .selectAll('.form-control')
          .attr('disabled',null)
        d3.select('#submit-patient')
          .attr('disabled',null)
        $("#new_patient_form")[0].reset();
        $('#dob-date').datepicker({
              autoclose: true,
              startView: 2
          });
        d3.select('#patientFormLabel').text('New patient');

        $('#patientForm').modal('show');
      }

      function processNotesData(data){
        return data.map(function(d){
          return {title: d.notes,
                  date: d.date,
                  color: (d.is_billed? '#A52A2A': '#5F9EA0'),
                  data: d}
          })
      }

      function delete_last_note(patient){

        $.getJSON('/sessions?pid='+patient.id, function(data){
          var s = data[0]
          if (!s){
            alert(`Patient ${patient.name} does not have any sessions to delete`);
          }
          else {
            if (confirm(`Delete session for ${s.name} on ${s.date}`)){
              $.post('/delete',{'sid': s.id}, function(res){
                if (res.status == 'error'){
                  alert(res.message)
                }
                else {
                  del_s = res.session;
                  alert(`Session for ${del_s.name} deleted. Number of sessions went from ${patient.session_number} to ${res.patient.session_number}.`);
                  new_session_flag = true;
                  new_patient_flag = true;
                  window.location.href = '/'
                }
              }, 'json')
            }
          }
        })
      }

      function display_notes(patient){
        d3.select('#notesListLabel')
          .text('Notes for ' + patient.name );
        $('#notesList').modal('show');

        $('#notesCalendar').fullCalendar('destroy');
        $.getJSON('/sessions?pid='+patient.id, function(data){

          $('#notesCalendar').fullCalendar({
               header: {
                  left: 'prev,next',
                  center: 'title',
                  right: ''
                },

              lazyFetching: true,
              defaultView: 'listMonth',
              events: processNotesData(data),
              
              eventClick: calendarEventClick,

              eventRender: function(event, eventElement) {
                var img_id = event.data.notes_img_id
                //console.log(event.title + img_id)
                //console.log(event.data.notes)
                if (img_id){
                  img_el = `<img class="img-responsive" src="/img?img_id=${img_id}"></img>`
                  eventElement.find("td.fc-list-item-title").html(img_el);
                } else{
                  eventElement.find("td.fc-list-item-title").html(event.title);
                }
              },
          });
        })
      }

      function load_sessions(){

        if (!new_session_flag){
          console.log('does not need to refresh sessions')
          return
        }
        console.log('loading new sessions')
        new_session_flag = false;
        todo_flag = false;

        $('#calendar').fullCalendar('destroy');

        $.getJSON('/sessions?pid=',function(data){
        
          $('#calendar').fullCalendar({

               themeSystem: 'bootstrap3',
               customButtons: {
                todo: {
                  click: function(){
                    todo_flag=!todo_flag;
                    $('#calendar').fullCalendar('rerenderEvents');
                  },
                  bootstrapGlyphicon: 'glyphicon-pencil',
                }
               },
               height: 550,
               header: {
                  left: 'prev,next today todo',
                  //left: '',
                  center: 'title',
                  //right: '',
                  right: 'month,listMonth'
                },

              lazyFetching: true,
              eventLimit: true, // allow "more" link when too many events
     
              defaultView: 'listMonth',
              //listDayAltFormat: false,
              events: processPatientData(data),
              eventClick: calendarEventClick,
              eventRender: function(event, element, view) {
                /*
                if (event.data.notes == 'TODO'){
                  if (view.name == 'month'){
                    element.css({'color':'Coral'});
                  }
                  else {
                    element.css({'color':'FireBrick'});
                  }
                }*/
                if (todo_flag){
                  return (event.data.notes == 'TODO');
                }
              }
          })
        })
      }

      function load_patients(){

        if (!new_patient_flag){
          return
        }
        new_patient_flag = false

        row = (item) => item.name;

        $.getJSON('/patient', function(data){

          var sorted_list = data.patient_list.sort(function(a,b){
            return (a.name.toLowerCase() > b.name.toLowerCase()? 1: -1)
          })

          console.log('patient info loaded')
          var table = d3.select('#patientTable');
          var tbody = table.select('tbody');
          var selection = tbody.selectAll('tr')
            .data(sorted_list);
            
          selection.text(row)

          selection.enter()
            .append('tr')
            .classed('inactive',(d) => (d.status == "Inactive"))
            .append('td')
            .append('a')
            .text(row)
            .on('click',function(item){
              display_patient_info(item);
            })

          selection.exit().remove();

          tbody.selectAll('a')
            .data(sorted_list)
            .append('span')
            .classed('invisible', (d) => (d.status == "Inactive"))
            .classed('glyphicon',true)
            .classed('glyphicon-plus',true)
            .classed('badge-pill',true)
            .attr('data-toggle','tooltip')
            .attr('title','click to add session')
            .on('click',function(item){
              $('#patientTable .glyphicon-plus').tooltip('hide')
              new_session(item);
              d3.event.stopPropagation();
            });
          tbody.selectAll('a')
            .data(sorted_list)
            .append('span')
            .classed('invisible', (d) => ((d.status == "Inactive") || (d.session_number == 0)))
            .classed('glyphicon',true)
            .classed('glyphicon-minus',true)
            .classed('badge-pill',true)
            .attr('data-toggle','tooltip')
            .attr('title','click to delete last note')
            .on('click',function(item){
              $('#patientTable .glyphicon-minus').tooltip('hide')
              delete_last_note(item);
              d3.event.stopPropagation();
            });
          tbody.selectAll('a')
            .data(sorted_list)
            .append('span')
            .classed('glyphicon',true)
            .classed('glyphicon-align-justify',true)
            .classed('badge-pill',true)
            .attr('data-toggle','tooltip')
            .attr('title','click to see notes')
            .on('click',function(item){
              $('#patientTable .glyphicon-align-justify').tooltip('hide')
              display_notes(item);
              d3.event.stopPropagation();
            });

          $('#patientTable .glyphicon-plus').tooltip()
          $('#patientTable .glyphicon-minus').tooltip()
          $('#patientTable .glyphicon-align-justify').tooltip()

          toggle_inactive();
        })
      }

      function write_checbox(name, write) {
        document.getElementsByName(name)[0].checked = (write == "on");
      }

      function write_dropdown(name, write) {
        document.getElementById(name).value = write
      }

      function populateSessionData(data){

        ['diag', 'diag_code', 'diag_2', 'diag_2_code', 'new_issue'].forEach(function(w){
          document.getElementById(w).value = data[w];
        })
        // special logic for 'modality', to deal with old codes.
        var m = data['modality'];
        if (m == "Individual"){
          m = "Individual-45min";
        }
        document.getElementById('modality').value = m;
        if (m == 'Other'){
          document.getElementById('mod_code_input').value = data['mod_code'];
          $('#mod_code_input').show()
        }

        write_checbox('no_new_issue', data['no_new_issue']);

        // risk assessment
        RACheckArray.forEach(function(k){
          write_checbox(k, data[k]);
        })

        // interventions
        /*
        Object.keys(TICheckDict).forEach(function(k){
          write_checbox(k, data[k]);
        })*/
        TICheckArr.forEach(function(k){
          write_checbox(k[0], data[k[0]]);
        })
        TITextArray.forEach(function(k){
          document.getElementById(k).value = data[k];
        })

        // goals
        GCheckArray.forEach(function(k){
          //console.log('populating ' + k);
          write_checbox(k, data[k]);
        })
        GTextArray.forEach(function(k){
          document.getElementById(k).value = data[k];
        })

        // SPA
        /*
        Object.keys(SPACheckDict).forEach(function(k){
          write_checbox(k, data[k]);
        })*/
        SPACheckArr.forEach(function(k){
          write_checbox(k[0], data[k[0]]);
        })
        SPATextArray.forEach(function(k){
          document.getElementById(k).value = data[k];
        })

        // Assessment
        ASSTextArray.forEach(function(k){
          document.getElementById(k).value = data[k];
        })

        // Plan
        PLNCheckArray.forEach(function(k){
          write_checbox(k, data[k]);
        })
        PLNTextArray.forEach(function(k){
          document.getElementById(k).value = data[k];
        })
      }

      function populateSession(data){

        setFormDisabled('#new_session_form', true);

        ['name', 'dob', 'notes'].forEach(function(s){
          document.getElementById(s).value = data[s];
        });

        if (data['notes'] == 'TODO'){
          write_checbox('to-do','on');
        }

        var img_id = data['notes_img_id']
        $('#new_session_form').attr('img_id', img_id)
        console.log("img id = "+$('#new_session_form').attr('img_id'))


        $("#img-file").hide()
        if (img_id){
          write_checbox('notes-attached','on');
          img_el = `<img class="img-responsive" src="/img?img_id=${img_id}"></img>`
          $("#img-notes").append(img_el).show()
          
          $("#notes").hide()
        }
        else{
          $("#notes").show()
          $("#img-notes > img").remove()
        }

        document.getElementById('insurance').value = data['insurance'];
        document.getElementById('patient_id').value = data['patient_id']
        document.getElementById('session_id').value = data['id']

        document.getElementById('seshdate').value = data['date'];
        document.getElementById('seshNo').value = data['session_number'];

        populateSessionData(data);

        d3.select('#sessionInfoLabel').text('Session');
      }

      /*
      function billing(final){
        route = "/billing?bill=" + (final? "Y" : "");
        generate_bill(route);
      }
      */

      function validate_session(){
        
        f = $('#seshdate').val();
        if (f == ""){
          alert("date cannot be empty");
          return false;
        }
        if (document.getElementById('notes-attached').checked){
          // if it is visible, then it is in edit mode
          // problem: once it is unclicked, it will forget the image.
          // solution: add attribute img_id to element to remember.
          if ($('#new_session_form').attr('img_id')){
            console.log('img-file exists')
            f = $('#notes').val();
            if (!f.startsWith('<img')){
              if (!confirm('Session note old image will be removed. Are you sure?')){
                alert('Correct and re-submit')
                return false;
              }
            }
          } else {
            f = $('#img-file').val();
            if (f ==""){
              alert("Notes image must be uploaded");
              return false;
            }
          }
        } else {
          f = $('#notes').val();
          if ((f == "") || (f == "Client reported:") ){
            alert("notes must be entered");
            return false;
          }      
        }
        f = $('#diag_code').val();
        if (f == ""){
          alert("diagnosis code cannot be empty");
          return false;
        } 

        new_issue_filled =  $('#new_issue').val() != "";
        if (!document.getElementById('no_new_issue').checked){
          if (!new_issue_filled){
            alert("new issue cannot be empty when 'None Reported' checkbox is unchecked");
            return false;
          }
        } 
        else {
          if (new_issue_filled){
            alert("new issue cannot be filled when 'None Reported' checkbox is checked");
            return false;
          }
        }

        if (($('select[name="modality"]').val()=='Other') && ($('input[name="mod_code"]').val()=='')){
            alert("If Modality is 'Other', Insurance code must be filled");
            return false;
        }
   
        return true;
      }

      function submit_session(){

        if (!validate_session()){
          return;
        };

        document.getElementById("new_session_form").submit();

        console.log('submitted')

        $('#session_info').modal('hide');
      }

      function edit_session(){

        setFormDisabled('#new_session_form', null);
        d3.selectAll('.data-ro')
          .attr('readonly',true);
        d3.selectAll('.non-editable')
          .attr('readonly',true);
        d3.select('#sessionSubmit')
          .classed('visible',true)
          .classed('invisible',null)
        d3.select('#sessionEdit')
          .classed('visible',null)
          .classed('invisible',true)

      }

      function new_session(patient){

        setFormDisabled('#session_info', null);
        d3.selectAll('.data-ro')
          .attr('readonly',true);
        d3.selectAll('.non-editable')
          .attr('readonly',false);          
        d3.select('#sessionSubmit')
          .classed('visible',true)
          .classed('invisible',null)
        d3.select('#sessionEdit')
          .classed('visible',null)
          .classed('invisible',true)

        //console.log("file: "+$('#img-file').val())

        $('#session_info').modal('show');
        $("#new_session_form")[0].reset();
        $('#notes').val('Client reported:').show()
        $('#img-file').hide()
        $("#img-notes > img").remove()        


        $.getJSON('/sessions?pid=' + patient.id, function (data) {
            $('#seshdate').datepicker('destroy');
            $('#seshdate').attr('placeholder', '')


            //console.log(data);
            if (data.length == 0){
              $('#seshdate').datepicker({
                  autoclose: true,
                  todayBtn: "linked",
                });
              return;
            }

            latest_data = data[0];

            $('#seshdate').attr('placeholder', 'last on '+latest_data.date)

            latest = moment(latest_data.date, "MM/DD/YYYY");

            // restrict datepicker
            $('#seshdate').datepicker({
                autoclose: true,
                todayBtn: "linked",
                startDate: latest.add(1,'day').toDate(),
            });

            populateSessionData(latest_data);

            // clear new_issue
            $('#new_issue').val("")
            write_checbox('no_new_issue', "on")
        });

        d3.select('#sessionInfoLabel').text('New session');

        // populate current values
        // DO NOT populate session_id
        document.getElementById('name').value = patient.name;
        document.getElementById('dob').value = patient.dob;
        document.getElementById('insurance').value = patient.insurance;
        document.getElementById('patient_id').value = patient.id;
        // incrememnt session number
        document.getElementById('seshNo').value = patient.session_number + 1


        $('#a-SI.collapsed').click();
      }

      function processPatientData(data){
        return data.map(function(d){
          return {title: d.name,
                  date: d.date,
                  color: (d.is_billed? '#A52A2A': '#5F9EA0'),
                  data: d}
          })
      }

      /*  done in python
      function generate_bill(route) {

        $.getJSON(route, function (data) {
            bills = data.Bill;
            csv = 'Name,Session Date,Procedure Code,DSM 5,Insurance\n';
            bills.forEach(function (row) {
                csv += row.name + ',';
                csv += row.session_date + ',';
                csv += row.bill_code + ',';
                csv += row.diag_code + ",";
                csv += row.insurance + ',';
                csv += "\n";
            });

            hiddenElement = document.createElement('a');
            hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
            hiddenElement.target = '_blank';
            now = moment();
            hiddenElement.download = 'billing_'+now.format("YYYY-MM-DD:HH:mm")+'.csv';
            hiddenElement.click();
        });

      }*/   

      var events = [];

      $( document ).ready(function() {

        console.log('document ready')

        if (navigator.userAgent.indexOf('Mobi')>-1){
          console.log(navigator.userAgent)
          $('#import').parent().addClass('disabled');
          $('#import').on('click',function(e){
            //alert('Functionality not available on mobile devices')
            e.preventDefault();
            e.stopPropagation();
          })
        }

        ['#diag_code','#diag_2_code'].forEach(function(el,idx){
          $(el).change(function(){
            code = $(el).val().toUpperCase()
            d = Codes.codes[$(el).val().toUpperCase()]
            $(el).val(code);
            $((idx==1? "#diag_2":"#diag")).val(d);
          })
        })

        // confirms closing of SI modal
        $('#session-info-close').on('click', function(event){
          if ($('#sessionSubmit').hasClass('visible') && !confirm('close without submitting?')){
            event.stopPropagation()
          }
        })

        // to-do listeners
        $('input[name="to-do"]').change(function(){
          if (this.checked){
            $("#notes").val("TODO")
            $("#img-notes").hide()
          }
          else {
            $("#notes").val("Client reported:")
          }
        })

        // notes-attached listeners
        $('input[name="notes-attached"]').change(function(){
          if (this.checked){
            $("#notes").hide()
            $("#img-file").show()
            $("#img-notes").show()
          }
          else {
            $("#notes").show()
            $("#img-file").hide()
          }
        })

        // patient search
        $("#patientSearchInput").keyup(function(){
          value = $(this).val().toLowerCase();
          $("#patientTable tr").filter(function() {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
          });
          $('#inactive').text('active');
        });

        // close navbar dropdown after choice
        $(document).on('click','.navbar-collapse.in',function(e) {
          if( $(e.target).is('a') ) {
              $(this).collapse('hide');
          }
        });

        todoPage();
        //patientPage();
      })

      /*
      load form.json, once it is loaded, load form.js. Then finish SI form
      */
      $.ajax({ 
        url: 'static/form.json', 
        dataType: 'json',
        success: function (data) { 

            console.log('form.json loaded')
            TICheckArr = data['TICheckArr']
            GoalsCheckArr = data['GoalsCheckArr']
            SPACheckArr = data['SPACheckArr']

            $.getScript('js/form.js', function(data){

              console.log('form.js loaded')

              createFormSectionArr('#TI-array', TICheckArr);
              addOtherToList(d3.select('#TI-array'),"TI_other_txt")

              createFormSectionArr('#Goals-array', GoalsCheckArr);
              addOtherToList(d3.select('#Goals-array'),"G_other_txt")
              createFormSectionArr('#SPA-array', SPACheckArr);
              addOtherToList(d3.select('#SPA-array'),"SPA_other_txt")
              addOtherToList(d3.select('#collapseASS').select('ul'),"ASS_other_txt")
              addOtherToList(d3.select('#collapsePLN').select('ul'),"PLN_other_txt")

              associateCheckText("no_new_issue", "new_issue")
              linkTextCheck("G_1_impr", "G_1_impr_txt")
              linkTextCheck("G_1_decr", "G_1_decr_txt")
              linkTextCheck("G_2_impr", "G_2_impr_txt")
              linkTextCheck("G_2_decr", "G_2_decr_txt")
              linkTextCheck("G_3_impr", "G_3_impr_txt")
              linkTextCheck("G_3_decr", "G_3_decr_txt")


              function adjust_pln_nxt(){
                freq = $('select[name="PLN_FREQ"]').val();
                weeks = 0;
                if (freq == "Weekly"){
                  weeks = 1
                }
                if (freq == "Bi-weekly") {
                  weeks = 2
                }
                if (freq == "Monthly") {
                  weeks = 4
                }
                let d = $('input[name="date"]').val();
                nxt = moment(d, "MM/DD/YYYY").add(weeks,'week').format('MM/DD/YYYY');
                $('input[name="PLN_NXT"]').val(nxt);
              }
              // PLN_FREQ
              $('input[name="date"]').change(adjust_pln_nxt);
              $('select[name="PLN_FREQ"]').change(adjust_pln_nxt);

              // MODALITY
              $('select[name="modality"]').change(function(){
                modality = $('select[name="modality"]');
                proc_code = $('#mod_code_input');
                if (modality.val() == 'Other'){
                  proc_code.show();
                }
                else{
                  proc_code.val('');
                  proc_code.hide();
                }
              });
            });

        },

        error: function(err, status, a){
          console.log(status)
        }
      });      

    </script>

  </body>
</html>